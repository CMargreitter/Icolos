
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>icolos.core.workflow_steps.pmx.base &#8212; icolos  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css" />
    <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for icolos.core.workflow_steps.pmx.base</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">asyncio</span> <span class="kn">import</span> <span class="n">run_coroutine_threadsafe</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">CompletedProcess</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Deque</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">icolos.core.containers.compound</span> <span class="kn">import</span> <span class="n">Compound</span><span class="p">,</span> <span class="n">Conformer</span>
<span class="kn">from</span> <span class="nn">icolos.core.containers.perturbation_map</span> <span class="kn">import</span> <span class="n">Node</span><span class="p">,</span> <span class="n">PerturbationMap</span>
<span class="kn">from</span> <span class="nn">rdkit.Chem</span> <span class="kn">import</span> <span class="n">rdmolops</span>
<span class="kn">from</span> <span class="nn">rdkit</span> <span class="kn">import</span> <span class="n">Chem</span>
<span class="kn">from</span> <span class="nn">icolos.core.containers.compound</span> <span class="kn">import</span> <span class="n">Compound</span><span class="p">,</span> <span class="n">Conformer</span>
<span class="kn">from</span> <span class="nn">icolos.core.containers.perturbation_map</span> <span class="kn">import</span> <span class="n">Node</span><span class="p">,</span> <span class="n">PerturbationMap</span>
<span class="kn">from</span> <span class="nn">icolos.core.workflow_steps.step</span> <span class="kn">import</span> <span class="n">StepBase</span>
<span class="kn">from</span> <span class="nn">icolos.utils.enums.parallelization</span> <span class="kn">import</span> <span class="n">ParallelizationEnum</span>
<span class="kn">from</span> <span class="nn">icolos.utils.enums.program_parameters</span> <span class="kn">import</span> <span class="n">GromacsEnum</span><span class="p">,</span> <span class="n">SlurmEnum</span><span class="p">,</span> <span class="n">StepPMXEnum</span>
<span class="kn">from</span> <span class="nn">icolos.utils.enums.step_enums</span> <span class="kn">import</span> <span class="n">StepGromacsEnum</span><span class="p">,</span> <span class="n">StepPMXSetupEnum</span>
<span class="kn">from</span> <span class="nn">icolos.utils.execute_external.execute</span> <span class="kn">import</span> <span class="n">Executor</span>
<span class="kn">from</span> <span class="nn">icolos.utils.execute_external.gromacs</span> <span class="kn">import</span> <span class="n">GromacsExecutor</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">icolos.utils.general.parallelization</span> <span class="kn">import</span> <span class="n">Parallelizer</span>
<span class="kn">from</span> <span class="nn">icolos.core.workflow_steps.step</span> <span class="kn">import</span> <span class="n">_LE</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="kn">from</span> <span class="nn">icolos.utils.general.progress_bar</span> <span class="kn">import</span> <span class="n">get_progress_bar_string</span>

<span class="n">_GE</span> <span class="o">=</span> <span class="n">GromacsEnum</span><span class="p">()</span>
<span class="n">_SGE</span> <span class="o">=</span> <span class="n">StepGromacsEnum</span><span class="p">()</span>
<span class="n">_SPSE</span> <span class="o">=</span> <span class="n">StepPMXSetupEnum</span><span class="p">()</span>
<span class="n">_SPE</span> <span class="o">=</span> <span class="n">StepPMXEnum</span><span class="p">()</span>
<span class="n">_PE</span> <span class="o">=</span> <span class="n">ParallelizationEnum</span>
<span class="n">_SE</span> <span class="o">=</span> <span class="n">SlurmEnum</span>


<div class="viewcode-block" id="StepPMXBase"><a class="viewcode-back" href="../../../../../icolos.core.workflow_steps.pmx.html#icolos.core.workflow_steps.pmx.base.StepPMXBase">[docs]</a><span class="k">class</span> <span class="nc">StepPMXBase</span><span class="p">(</span><span class="n">StepBase</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class containing shared methods for Non-equilibrium free energy calculations</span>
<span class="sd">    Additional settings (these apply to any step that inherits StepPMXBase)</span>
<span class="sd">    :str run_type: specify absolute or relative mode, default = rbfe</span>
<span class="sd">    :str boxshape: specify the boxshape to use in calculation setup, deafult = dodecahedron</span>
<span class="sd">    :float boxd: spefify solvent box buffer dimention, default = 1.5</span>
<span class="sd">    :str water: specify water model, default = tip3p</span>
<span class="sd">    :float conc: specify salt concentration, default=0.15</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_antechamber_executor</span><span class="p">:</span> <span class="n">Executor</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_gromacs_executor</span><span class="p">:</span> <span class="n">Executor</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sim_types</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">states</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">therm_cycle_branches</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">run_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ff</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">boxshape</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">boxd</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">water</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">conc</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">nname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mdp_prefixes</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_antechamber_executor</span> <span class="o">=</span> <span class="n">Executor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gromacs_executor</span> <span class="o">=</span> <span class="n">GromacsExecutor</span><span class="p">(</span>
            <span class="n">prefix_execution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">execution</span><span class="o">.</span><span class="n">prefix_execution</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;em&quot;</span><span class="p">,</span> <span class="s2">&quot;nvt&quot;</span><span class="p">,</span> <span class="s2">&quot;eq&quot;</span><span class="p">,</span> <span class="s2">&quot;transitions&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;stateA&quot;</span><span class="p">,</span> <span class="s2">&quot;stateB&quot;</span><span class="p">]</span>
        <span class="c1"># for a normal pmx run this would be &quot;water&quot; and &quot;protein&quot;</span>
        <span class="c1"># unbound -&gt; ligand, bound -&gt; complex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">therm_cycle_branches</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;unbound&quot;</span><span class="p">,</span> <span class="s2">&quot;bound&quot;</span><span class="p">]</span>

        <span class="c1"># simulation setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_additional_setting</span><span class="p">(</span><span class="n">_SPE</span><span class="o">.</span><span class="n">RUN_TYPE</span><span class="p">,</span> <span class="s2">&quot;rbfe&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff</span> <span class="o">=</span> <span class="s2">&quot;amber99sb-star-ildn-mut.ff&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxshape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_additional_setting</span><span class="p">(</span><span class="n">_SPE</span><span class="o">.</span><span class="n">BOXSHAPE</span><span class="p">,</span> <span class="s2">&quot;dodecahedron&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_additional_setting</span><span class="p">(</span><span class="n">_SPE</span><span class="o">.</span><span class="n">BOXD</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">water</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_additional_setting</span><span class="p">(</span><span class="n">_SPE</span><span class="o">.</span><span class="n">WATER</span><span class="p">,</span> <span class="s2">&quot;tip3p&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_additional_setting</span><span class="p">(</span><span class="n">_SPE</span><span class="o">.</span><span class="n">CONC</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_additional_setting</span><span class="p">(</span><span class="n">_SPE</span><span class="o">.</span><span class="n">PNAME</span><span class="p">,</span> <span class="s2">&quot;NaJ&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_additional_setting</span><span class="p">(</span><span class="n">_SPE</span><span class="o">.</span><span class="n">NNAME</span><span class="p">,</span> <span class="s2">&quot;ClJ&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mdp_prefixes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;em&quot;</span><span class="p">:</span> <span class="s2">&quot;em&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nvt&quot;</span><span class="p">:</span> <span class="s2">&quot;nvt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;npt&quot;</span><span class="p">:</span> <span class="s2">&quot;npt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eq&quot;</span><span class="p">:</span> <span class="s2">&quot;eq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transitions&quot;</span><span class="p">:</span> <span class="s2">&quot;ti&quot;</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_get_specific_path</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">workPath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">edge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bHybridStrTop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">wp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">r</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Utility function for getting the right paths from a pmx-type directory structure.  Works for both rbfe and abfe runs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">edge</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">workPath</span>
        <span class="n">edgepath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">workPath</span><span class="p">,</span> <span class="n">edge</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bHybridStrTop</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">hybridStrPath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/hybridStrTop&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">edgepath</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">hybridStrPath</span>

        <span class="k">if</span> <span class="n">wp</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">edgepath</span>
        <span class="n">wppath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">edgepath</span><span class="p">,</span> <span class="n">wp</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wppath</span>
        <span class="n">statepath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">wppath</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">statepath</span>
        <span class="n">runpath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/run</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">statepath</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sim</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">runpath</span>
        <span class="n">simpath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">runpath</span><span class="p">,</span> <span class="n">sim</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">simpath</span>

    <span class="k">def</span> <span class="nf">_parametrise_protein</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">protein</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;protein.pdb&quot;</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;input/protein&quot;</span><span class="p">,</span>
        <span class="n">output</span><span class="o">=</span><span class="s2">&quot;protein.pdb&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># run pdb2gmx on the protein</span>
        <span class="n">pdb2gmx_args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">protein</span><span class="p">),</span>
            <span class="s2">&quot;-ignh&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-water&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">additional</span><span class="p">[</span><span class="s2">&quot;water&quot;</span><span class="p">],</span>
            <span class="s2">&quot;-ff&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">additional</span><span class="p">[</span><span class="s2">&quot;forcefield&quot;</span><span class="p">],</span>
            <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">output</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend_executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">command</span><span class="o">=</span><span class="n">_GE</span><span class="o">.</span><span class="n">PDB2GMX</span><span class="p">,</span>
            <span class="n">arguments</span><span class="o">=</span><span class="n">pdb2gmx_args</span><span class="p">,</span>
            <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">path</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_single_tpr</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">simpath</span><span class="p">,</span>
        <span class="n">toppath</span><span class="p">,</span>
        <span class="n">state</span><span class="p">,</span>
        <span class="n">sim_type</span><span class="p">,</span>
        <span class="n">executor</span><span class="p">,</span>
        <span class="n">empath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompletedProcess</span><span class="p">:</span>
        <span class="n">mdp_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;input/mdp&quot;</span><span class="p">)</span>
        <span class="n">mdp_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mdp_prefixes</span><span class="p">[</span><span class="n">sim_type</span><span class="p">]</span>

        <span class="c1"># TODO: is this a liability? would we ever have more than a single topol file?</span>
        <span class="n">top</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/*.top&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">toppath</span><span class="p">)</span>
        <span class="n">tpr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/tpr.tpr&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simpath</span><span class="p">)</span>
        <span class="n">mdout</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/mdout.mdp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simpath</span><span class="p">)</span>
        <span class="c1"># mdp</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;stateA&quot;</span><span class="p">:</span>
            <span class="n">mdp</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">_l0.mdp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mdp_path</span><span class="p">,</span> <span class="n">mdp_prefix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mdp</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/</span><span class="si">{1}</span><span class="s2">_l1.mdp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mdp_path</span><span class="p">,</span> <span class="n">mdp_prefix</span><span class="p">)</span>
        <span class="c1"># TODO: deal with nvt/npt for abfe</span>
        <span class="c1"># str</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sim_type</span> <span class="o">==</span> <span class="s2">&quot;transitions&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sim_type</span> <span class="o">==</span> <span class="s2">&quot;em&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_type</span> <span class="o">==</span> <span class="s2">&quot;rbfe&quot;</span><span class="p">:</span>
                    <span class="n">inStr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">toppath</span><span class="si">}</span><span class="s2">/ions.pdb&quot;</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_type</span> <span class="o">==</span> <span class="s2">&quot;abfe&quot;</span><span class="p">:</span>
                    <span class="n">inStr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">toppath</span><span class="si">}</span><span class="s2">/genion.gro&quot;</span>
            <span class="k">elif</span> <span class="n">sim_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;eq&quot;</span><span class="p">,</span> <span class="s2">&quot;nvt&quot;</span><span class="p">,</span> <span class="s2">&quot;npt&quot;</span><span class="p">):</span>
                <span class="n">inStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/confout.gro&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">empath</span><span class="p">)</span>

            <span class="n">grompp_args</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
                <span class="n">mdp</span><span class="p">,</span>
                <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
                <span class="n">inStr</span><span class="p">,</span>
                <span class="s2">&quot;-r&quot;</span><span class="p">,</span>
                <span class="n">inStr</span><span class="p">,</span>
                <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
                <span class="n">top</span><span class="p">,</span>
                <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
                <span class="n">tpr</span><span class="p">,</span>
                <span class="s2">&quot;-maxwarn&quot;</span><span class="p">,</span>
                <span class="mi">4</span><span class="p">,</span>
                <span class="s2">&quot;-po&quot;</span><span class="p">,</span>
                <span class="n">mdout</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">tpr</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">command</span><span class="o">=</span><span class="n">_GE</span><span class="o">.</span><span class="n">GROMPP</span><span class="p">,</span>
                    <span class="n">arguments</span><span class="o">=</span><span class="n">grompp_args</span><span class="p">,</span>
                    <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">location</span><span class="o">=</span><span class="n">simpath</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;tpr file </span><span class="si">{</span><span class="n">tpr</span><span class="si">}</span><span class="s2"> already exists, skipping&quot;</span><span class="p">,</span> <span class="n">_LE</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">sim_type</span> <span class="o">==</span> <span class="s2">&quot;transitions&quot;</span><span class="p">:</span>
            <span class="n">grompp_full_cmd</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># 80 frames = 0 - 79</span>
            <span class="n">num_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">simpath</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;frame&quot;</span><span class="p">)])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Generating transition tpr files for </span><span class="si">{</span><span class="n">num_frames</span><span class="si">}</span><span class="s2"> frames&quot;</span><span class="p">,</span> <span class="n">_LE</span><span class="o">.</span><span class="n">DEBUG</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_frames</span><span class="p">):</span>
                <span class="n">inStr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">simpath</span><span class="si">}</span><span class="s2">/frame</span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s2">.gro&quot;</span>
                <span class="n">tpr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">simpath</span><span class="si">}</span><span class="s2">/ti</span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s2">.tpr&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">simpath</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

                <span class="n">grompp_args</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;gmx grompp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
                    <span class="n">mdp</span><span class="p">,</span>
                    <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
                    <span class="n">inStr</span><span class="p">,</span>
                    <span class="s2">&quot;-r&quot;</span><span class="p">,</span>
                    <span class="n">inStr</span><span class="p">,</span>
                    <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
                    <span class="n">top</span><span class="p">,</span>
                    <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
                    <span class="n">tpr</span><span class="p">,</span>
                    <span class="s2">&quot;-maxwarn&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;4&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;-po&quot;</span><span class="p">,</span>
                    <span class="n">mdout</span><span class="p">,</span>
                    <span class="s2">&quot;;&quot;</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">tpr</span><span class="p">):</span>
                    <span class="n">grompp_full_cmd</span> <span class="o">+=</span> <span class="n">grompp_args</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;tpr file </span><span class="si">{</span><span class="n">tpr</span><span class="si">}</span><span class="s2"> already exists, skipping&quot;</span><span class="p">,</span> <span class="n">_LE</span><span class="o">.</span><span class="n">DEBUG</span>
                    <span class="p">)</span>
            <span class="n">grompp_full_cmd</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grompp_full_cmd</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1"># check all transitions have not been skipped</span>
            <span class="k">if</span> <span class="n">grompp_full_cmd</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running grompp&quot;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">command</span><span class="o">=</span><span class="n">grompp_full_cmd</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">[],</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">simpath</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_backup_files</span><span class="p">(</span><span class="n">simpath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_pdb_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;pdb&quot;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">cleaned_lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;ATOM&quot;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s2">&quot;HETATM&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">cleaned_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">cleaned_lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parametrisation_pipeline</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">,</span> <span class="n">conf</span><span class="p">:</span> <span class="n">Conformer</span><span class="p">,</span> <span class="n">include_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_gro</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="c1"># main pipeline for producing GAFF parameters for a ligand</span>
        <span class="n">charge_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_additional_setting</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">_SPSE</span><span class="o">.</span><span class="n">CHARGE_METHOD</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;bcc&quot;</span>
        <span class="p">)</span>
        <span class="n">formal_charge</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">rdmolops</span><span class="o">.</span><span class="n">GetFormalCharge</span><span class="p">(</span><span class="n">conf</span><span class="o">.</span><span class="n">get_molecule</span><span class="p">())</span> <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">arguments_acpype</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;-di&quot;</span><span class="p">,</span>
            <span class="s2">&quot;MOL.sdf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-c&quot;</span><span class="p">,</span>
            <span class="n">charge_method</span><span class="p">,</span>
            <span class="s2">&quot;-a&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gaff2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-n&quot;</span><span class="p">,</span>
            <span class="n">formal_charge</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Generating ligand parameters...&quot;</span><span class="p">,</span> <span class="n">_LE</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend_executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">command</span><span class="o">=</span><span class="n">_GE</span><span class="o">.</span><span class="n">ACPYPE_BINARY</span><span class="p">,</span>
            <span class="n">arguments</span><span class="o">=</span><span class="n">arguments_acpype</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">tmp_dir</span><span class="p">,</span>
            <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># search the output dir for the itp file</span>
        <span class="n">acpype_dir</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.acpype&quot;</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">itp_file</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">f</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">acpype_dir</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;GMX.itp&quot;</span><span class="p">)</span>
        <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pdb_file</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">f</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">acpype_dir</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;NEW.pdb&quot;</span><span class="p">)</span>
        <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">acpype_dir</span><span class="p">,</span> <span class="n">itp_file</span><span class="p">),</span>
            <span class="c1"># standardized name must be enforced here to make argument</span>
            <span class="c1"># parsing easier in subsequent pmx steps</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s2">&quot;MOL.itp&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">acpype_dir</span><span class="p">,</span> <span class="n">pdb_file</span><span class="p">),</span>
            <span class="c1"># standardized name must be enforced here to make argument</span>
            <span class="c1"># parsing easier in subsequent pmx steps</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s2">&quot;MOL.pdb&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># for abfe calculations we need the ligand_GMX.top + .gro files as well</span>
        <span class="k">if</span> <span class="n">include_top</span><span class="p">:</span>
            <span class="n">top_file</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">f</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">acpype_dir</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;GMX.top&quot;</span><span class="p">)</span>
            <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">acpype_dir</span><span class="p">,</span> <span class="n">top_file</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">top_file</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">include_gro</span><span class="p">:</span>
            <span class="n">gro_file</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">f</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">acpype_dir</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;GMX.gro&quot;</span><span class="p">)</span>
            <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">acpype_dir</span><span class="p">,</span> <span class="n">gro_file</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">gro_file</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_job_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="c1"># get the loaded tasks from the subtask container</span>

        <span class="c1"># while self._subtask_container.done() is False:</span>
        <span class="n">job_generator</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask_container</span><span class="o">.</span><span class="n">get_todo_tasks</span><span class="p">())</span>
        <span class="n">n_jobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtask_container</span><span class="o">.</span><span class="n">get_todo_tasks</span><span class="p">())</span>
        <span class="n">current_jobs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># initially fill the queue with N jobs</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_jobs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">execution</span><span class="o">.</span><span class="n">parallelization</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">job_generator</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">increment_tries</span><span class="p">()</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">current_jobs</span><span class="p">]</span>
        <span class="c1"># submit the initial job pool</span>
        <span class="n">queue_exhausted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">previous_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">done_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">done_count</span> <span class="o">&lt;</span> <span class="n">n_jobs</span><span class="p">:</span>
            <span class="c1"># loop through the jobs:</span>
            <span class="n">done_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtask_container</span><span class="o">.</span><span class="n">get_done_tasks</span><span class="p">())</span>
            <span class="n">running_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtask_container</span><span class="o">.</span><span class="n">get_running_tasks</span><span class="p">())</span>
            <span class="n">ready_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subtask_container</span><span class="o">.</span><span class="n">get_todo_tasks</span><span class="p">())</span>

            <span class="n">current_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">done_count</span><span class="p">,</span> <span class="n">running_count</span><span class="p">,</span> <span class="n">ready_count</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">current_metrics</span> <span class="o">!=</span> <span class="n">previous_metrics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot; Execution Summary: PENDING: </span><span class="si">{</span><span class="n">ready_count</span><span class="si">}</span><span class="se">\t</span><span class="s2">RUNNING: </span><span class="si">{</span><span class="n">running_count</span><span class="si">}</span><span class="se">\t</span><span class="s2">DONE: </span><span class="si">{</span><span class="n">done_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">_LE</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">prog_string</span> <span class="o">=</span> <span class="n">get_progress_bar_string</span><span class="p">(</span>
                    <span class="n">done_count</span><span class="p">,</span> <span class="n">done_count</span> <span class="o">+</span> <span class="n">running_count</span> <span class="o">+</span> <span class="n">ready_count</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prog_string</span><span class="p">,</span> <span class="n">_LE</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="n">previous_metrics</span> <span class="o">=</span> <span class="n">current_metrics</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">current_jobs</span><span class="p">:</span>
                <span class="c1"># job is ready to go, dispatch it to Slurm</span>
                <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">_PE</span><span class="o">.</span><span class="n">STATUS_READY</span><span class="p">:</span>
                    <span class="n">job_id</span> <span class="o">=</span> <span class="n">run_func</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">set_job_id</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">_PE</span><span class="o">.</span><span class="n">STATUS_RUNNING</span><span class="p">)</span>
                <span class="c1"># check the job status</span>
                <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">_PE</span><span class="o">.</span><span class="n">STATUS_RUNNING</span><span class="p">:</span>
                    <span class="c1"># check to see whether it&#39;s finished</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend_executor</span><span class="o">.</span><span class="n">_check_job_status</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">_SE</span><span class="o">.</span><span class="n">COMPLETED</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> COMPLETED&quot;</span><span class="p">,</span> <span class="n">_LE</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">set_status_success</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">_SE</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> FAILED!&quot;</span><span class="p">,</span> <span class="n">_LE</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">set_status_failed</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">_SE</span><span class="o">.</span><span class="n">CANCELLED</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> was CANCELLED!&quot;</span><span class="p">,</span> <span class="n">_LE</span><span class="o">.</span><span class="n">WARNING</span>
                        <span class="p">)</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">set_status_failed</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">_SE</span><span class="o">.</span><span class="n">NODE_FAIL</span><span class="p">:</span>
                        <span class="c1"># aws revoked the spot instance.  Resubmit the job</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> was revoked, resubmitting...&quot;</span><span class="p">,</span> <span class="n">_LE</span><span class="o">.</span><span class="n">DEBUG</span>
                        <span class="p">)</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">_PE</span><span class="o">.</span><span class="n">STATUS_READY</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_SE</span><span class="o">.</span><span class="n">RUNNING</span><span class="p">,</span> <span class="n">_SE</span><span class="o">.</span><span class="n">PENDING</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Unhandled job state </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> for job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="n">_LE</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">job</span><span class="o">.</span><span class="n">set_status_failed</span><span class="p">()</span>

                <span class="c1"># if complete, succesfully or not, remove the job from the queue, prepare another</span>
                <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="n">_PE</span><span class="o">.</span><span class="n">STATUS_SUCCESS</span><span class="p">,</span> <span class="n">_PE</span><span class="o">.</span><span class="n">STATUS_FAILED</span><span class="p">):</span>
                    <span class="n">current_jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">queue_exhausted</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">new_job</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">job_generator</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing new job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">_LE</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                            <span class="n">new_job</span><span class="o">.</span><span class="n">increment_tries</span><span class="p">()</span>
                            <span class="n">current_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_job</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Reached end of job queue&quot;</span><span class="p">,</span> <span class="n">_LE</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
                            <span class="n">queue_exhausted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_execute_pmx_step_parallel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">run_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">step_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">result_checker</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">prune_completed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiates Icolos&#39;s parallelizer object,</span>
<span class="sd">        runs the step&#39;s execute method,</span>
<span class="sd">        passes any kwargs straight to the run_func</span>
<span class="sd">        If result_checker is provided,</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parallelizer</span> <span class="o">=</span> <span class="n">Parallelizer</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">run_func</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subtask_container</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>

            <span class="n">next_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sublists</span><span class="p">(</span>
                <span class="n">get_first_n_lists</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_number_cores</span><span class="p">()</span>
            <span class="p">)</span>  <span class="c1"># return n lists of length max_sublist_length</span>
            <span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">sub</span><span class="o">.</span><span class="n">increment_tries</span><span class="p">()</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">next_batch</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">element</span><span class="p">]</span>
            <span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">sub</span><span class="o">.</span><span class="n">set_status_failed</span><span class="p">()</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">next_batch</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">element</span><span class="p">]</span>

            <span class="n">jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_edges</span><span class="p">(</span><span class="n">next_batch</span><span class="p">)</span>
            <span class="n">n_removed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">prune_completed</span><span class="p">:</span>
                <span class="n">pre_exec_results</span> <span class="o">=</span> <span class="n">result_checker</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">job_sublist</span><span class="p">,</span> <span class="n">exec_success_sublist</span><span class="p">,</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">jobs</span><span class="p">,</span> <span class="n">pre_exec_results</span><span class="p">,</span> <span class="n">next_batch</span>
                <span class="p">):</span>
                    <span class="c1"># we test on the subtask level, not the individual job level, but since jobs are run through with max_len_sublists=1, in practice this doesn&#39;t matter</span>
                    <span class="k">for</span> <span class="n">job</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                        <span class="n">job_sublist</span><span class="p">,</span> <span class="n">exec_success_sublist</span><span class="p">,</span> <span class="n">sublist</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="c1"># remove the entire sublist (one fewer cores running)</span>
                            <span class="n">job_sublist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                            <span class="n">task</span><span class="o">.</span><span class="n">set_status_success</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Removed job </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> from execution batch, good output found&quot;</span><span class="p">,</span>
                                <span class="n">_LE</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                            <span class="p">)</span>
                            <span class="n">n_removed</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="c1"># if we have emptied entire job queues, remove the queue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Executing </span><span class="si">{</span><span class="n">step_id</span><span class="si">}</span><span class="s2"> for batch </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">, containing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> * </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">execution</span><span class="o">.</span><span class="n">parallelization</span><span class="o">.</span><span class="n">max_length_sublists</span><span class="si">}</span><span class="s2"> jobs&quot;</span><span class="p">,</span>
                    <span class="n">_LE</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span> <span class="k">if</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">parallelizer</span><span class="o">.</span><span class="n">execute_parallel</span><span class="p">(</span><span class="n">jobs</span><span class="o">=</span><span class="n">jobs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Checking execution results...&quot;</span><span class="p">,</span> <span class="n">_LE</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="n">batch_results</span> <span class="o">=</span> <span class="n">result_checker</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span>
            <span class="n">good_results</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">task</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">next_batch</span><span class="p">,</span> <span class="n">batch_results</span><span class="p">):</span>
                <span class="c1"># returns boolean arrays: False =&gt; failed job</span>
                <span class="k">for</span> <span class="n">subtask</span><span class="p">,</span> <span class="n">sub_result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">sub_result</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">subtask</span><span class="o">.</span><span class="n">set_status_failed</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: job </span><span class="si">{</span><span class="n">subtask</span><span class="si">}</span><span class="s2"> failed!&quot;</span><span class="p">,</span> <span class="n">_LE</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">get_perturbation_map</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_perturbation_map</span><span class="p">()</span><span class="o">.</span><span class="n">strict_execution</span>
                            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subtask</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                        <span class="p">):</span>
                            <span class="n">edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_perturbation_map</span><span class="p">()</span><span class="o">.</span><span class="n">get_edge_by_id</span><span class="p">(</span>
                                <span class="n">subtask</span><span class="o">.</span><span class="n">data</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">edge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">edge</span><span class="o">.</span><span class="n">_set_status</span><span class="p">(</span><span class="n">_PE</span><span class="o">.</span><span class="n">STATUS_FAILED</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">subtask</span><span class="o">.</span><span class="n">set_status_success</span><span class="p">()</span>
                        <span class="n">good_results</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;EXECUTION SUMMARY: Completed </span><span class="si">{</span><span class="n">good_results</span><span class="si">}</span><span class="s2"> jobs successfully (out of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">next_batch</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_batch</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2"> jobs for step </span><span class="si">{</span><span class="n">step_id</span><span class="si">}</span><span class="s2">. Removed </span><span class="si">{</span><span class="n">n_removed</span><span class="si">}</span><span class="s2"> already completed jobs&quot;</span><span class="p">,</span>
                <span class="n">_LE</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_log_execution_progress</span><span class="p">()</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

<div class="viewcode-block" id="StepPMXBase.get_edges"><a class="viewcode-back" href="../../../../../icolos.core.workflow_steps.pmx.html#icolos.core.workflow_steps.pmx.base.StepPMXBase.get_edges">[docs]</a>    <span class="k">def</span> <span class="nf">get_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inspect the map object  passed to the step and extract the edge info</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_workflow_object</span><span class="p">()</span><span class="o">.</span><span class="n">workflow_data</span><span class="o">.</span><span class="n">perturbation_map</span><span class="o">.</span><span class="n">edges</span></div>

<div class="viewcode-block" id="StepPMXBase.get_nodes"><a class="viewcode-back" href="../../../../../icolos.core.workflow_steps.pmx.html#icolos.core.workflow_steps.pmx.base.StepPMXBase.get_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">get_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return the nodes attached to the perturbation map</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_workflow_object</span><span class="p">()</span><span class="o">.</span><span class="n">workflow_data</span><span class="o">.</span><span class="n">perturbation_map</span><span class="o">.</span><span class="n">nodes</span></div>

    <span class="k">def</span> <span class="nf">_get_line_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">id_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">id_str</span> <span class="ow">in</span> <span class="n">e</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_protein</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">existing_itp_files</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">f</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;input/protein&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;itp&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Protein&quot;</span> <span class="ow">in</span> <span class="n">f</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">existing_itp_files</span>
        <span class="p">):</span>  <span class="c1"># no protein itp files, we have a single chain that needs extacting from the top file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;input/protein/topol.top&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">top_lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

            <span class="n">moltype_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_line_idx</span><span class="p">(</span><span class="n">top_lines</span><span class="p">,</span> <span class="n">_GE</span><span class="o">.</span><span class="n">MOLECULETYPES</span><span class="p">)</span>

            <span class="n">end_itp_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_line_idx</span><span class="p">(</span><span class="n">top_lines</span><span class="p">,</span> <span class="s2">&quot;; Include water topology&quot;</span><span class="p">)</span>

            <span class="n">moltype</span> <span class="o">=</span> <span class="n">top_lines</span><span class="p">[</span><span class="n">moltype_line</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cleaned_top</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">top_lines</span><span class="p">[:</span><span class="n">moltype_line</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;#include &quot;topol_</span><span class="si">{</span><span class="n">moltype</span><span class="si">}</span><span class="s1">.itp&#39;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">top_lines</span><span class="p">[</span><span class="n">end_itp_line</span><span class="p">:]</span>
            <span class="p">)</span>

            <span class="n">itp_lines</span> <span class="o">=</span> <span class="n">top_lines</span><span class="p">[</span><span class="n">moltype_line</span><span class="p">:</span><span class="n">end_itp_line</span><span class="p">]</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;input/protein/topol.top&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">cleaned_top</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;input/protein/topol_</span><span class="si">{</span><span class="n">moltype</span><span class="si">}</span><span class="s2">.itp&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">itp_lines</span><span class="p">)</span>

<div class="viewcode-block" id="StepPMXBase.get_hub_conformer"><a class="viewcode-back" href="../../../../../icolos.core.workflow_steps.pmx.html#icolos.core.workflow_steps.pmx.base.StepPMXBase.get_hub_conformer">[docs]</a>    <span class="k">def</span> <span class="nf">get_hub_conformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hub_conf_path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Conformer</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return _type_: _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">Chem</span><span class="o">.</span><span class="n">SDMolSupplier</span><span class="p">(</span><span class="n">hub_conf_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">supplier</span><span class="p">:</span>
            <span class="n">hub_mol</span> <span class="o">=</span> <span class="n">supplier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Conformer</span><span class="p">(</span><span class="n">conformer</span><span class="o">=</span><span class="n">hub_mol</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_construct_perturbation_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">replicas</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_perturbation_map</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Perturbation map already constructed&quot;</span><span class="p">,</span> <span class="n">_LE</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_perturbation_map</span><span class="p">()</span><span class="o">.</span><span class="n">protein</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">generic</span><span class="o">.</span><span class="n">get_argument_by_extension</span><span class="p">(</span><span class="s2">&quot;pdb&quot;</span><span class="p">,</span> <span class="n">rtn_file_object</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_perturbation_map</span><span class="p">()</span><span class="o">.</span><span class="n">replicas</span> <span class="o">=</span> <span class="n">replicas</span>
            <span class="k">return</span>
        <span class="n">topology</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_additional_setting</span><span class="p">(</span><span class="s2">&quot;topology&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">)</span>
        <span class="c1"># check whether a hub conformer has been supplied (as an sdf file)</span>
        <span class="n">hub_conf_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_additional_setting</span><span class="p">(</span><span class="s2">&quot;hub_conformer&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hub_conf_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">hub_conf_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span>
                <span class="s2">&quot;.sdf&quot;</span>
            <span class="p">),</span> <span class="s2">&quot;Hub conformer must be supplied as an SDF file!&quot;</span>

        <span class="n">perturbation_map</span> <span class="o">=</span> <span class="n">PerturbationMap</span><span class="p">(</span>
            <span class="n">compounds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">compounds</span><span class="p">,</span>
            <span class="n">protein</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">generic</span><span class="o">.</span><span class="n">get_argument_by_extension</span><span class="p">(</span>
                <span class="s2">&quot;pdb&quot;</span><span class="p">,</span> <span class="n">rtn_file_object</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">),</span>
            <span class="n">replicas</span><span class="o">=</span><span class="n">replicas</span><span class="p">,</span>
            <span class="n">strict_execution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_additional_setting</span><span class="p">(</span><span class="n">_SPE</span><span class="o">.</span><span class="n">STRICT</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">hub_conformer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_hub_conformer</span><span class="p">(</span><span class="n">hub_conf_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hub_conf_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">topology</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
            <span class="c1"># construct the perturbation map and load in the log file</span>
            <span class="n">log_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">generic</span><span class="o">.</span><span class="n">get_argument_by_extension</span><span class="p">(</span>
                <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">rtn_file_object</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">log_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">work_dir</span><span class="p">)</span>

            <span class="n">perturbation_map</span><span class="o">.</span><span class="n">parse_map_file</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">log_file</span><span class="o">.</span><span class="n">get_file_name</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">topology</span> <span class="o">==</span> <span class="s2">&quot;star&quot;</span><span class="p">:</span>
            <span class="c1"># manually generate star top, no mapping tool required</span>
            <span class="n">perturbation_map</span><span class="o">.</span><span class="n">generate_star_map</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Initialised perturbation map with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">perturbation_map</span><span class="o">.</span><span class="n">get_nodes</span><span class="p">())</span><span class="si">}</span><span class="s2"> nodes and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">perturbation_map</span><span class="o">.</span><span class="n">get_edges</span><span class="p">())</span><span class="si">}</span><span class="s2"> edges&quot;</span><span class="p">,</span>
            <span class="n">_LE</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_workflow_object</span><span class="p">()</span><span class="o">.</span><span class="n">set_perturbation_map</span><span class="p">(</span><span class="n">perturbation_map</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
            <span class="n">task_edges</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">task</span><span class="p">:</span>
                <span class="n">task_edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task_edges</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">edges</span>

    <span class="k">def</span> <span class="nf">_log_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">CompletedProcess</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger_blank</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">_LE</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clean_backup_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">toclean</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">/*#&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">clean</span> <span class="ow">in</span> <span class="n">toclean</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">clean</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_separate_atomtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lig_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lig_path</span><span class="p">,</span> <span class="s2">&quot;MOL.itp&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">itp_lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

        <span class="n">start_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_line_idx</span><span class="p">(</span><span class="n">itp_lines</span><span class="p">,</span> <span class="n">_GE</span><span class="o">.</span><span class="n">ATOMTYPES</span><span class="p">)</span>
        <span class="n">stop_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_line_idx</span><span class="p">(</span><span class="n">itp_lines</span><span class="p">,</span> <span class="n">_GE</span><span class="o">.</span><span class="n">MOLECULETYPES</span><span class="p">)</span>

        <span class="n">atomtype_lines</span> <span class="o">=</span> <span class="n">itp_lines</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">stop_index</span><span class="p">]</span>
        <span class="n">cleaned_itp_lines</span> <span class="o">=</span> <span class="n">itp_lines</span><span class="p">[</span><span class="n">stop_index</span><span class="p">:]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lig_path</span><span class="p">,</span> <span class="s2">&quot;MOL.itp&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">cleaned_itp_lines</span><span class="p">)</span>

        <span class="c1"># process the atomtype lines to remove the bondtype</span>
        <span class="c1"># col causes gmx to complain</span>
        <span class="n">cleaned_atomtype_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">atomtype_lines</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">cleaned_parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="n">cleaned_atomtype_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cleaned_parts</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lig_path</span><span class="p">,</span> <span class="s2">&quot;ffMOL.itp&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">cleaned_atomtype_lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parametrise_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jobs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">jobs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Node</span><span class="p">):</span>
            <span class="n">node_id</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_node_hash</span><span class="p">()</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">conformer</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">Compound</span><span class="p">):</span>
            <span class="c1"># in abfe we pass compounds here not edges</span>
            <span class="n">node_id</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_index_string</span><span class="p">()</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_enumerations</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_conformers</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot parametrize object of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">lig_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="s2">&quot;ligands&quot;</span><span class="p">,</span> <span class="n">node_id</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">lig_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">conf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lig_path</span><span class="p">,</span> <span class="s2">&quot;MOL.sdf&quot;</span><span class="p">))</span>

        <span class="c1"># now run ACPYPE on the ligand to produce the topology file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parametrisation_pipeline</span><span class="p">(</span><span class="n">lig_path</span><span class="p">,</span> <span class="n">conf</span><span class="o">=</span><span class="n">conf</span><span class="p">)</span>

        <span class="c1"># produces MOL.itp, need to separate the atomtypes directive out into ffMOL.itp for pmx</span>
        <span class="c1"># to generate the forcefield later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_separate_atomtypes</span><span class="p">(</span><span class="n">lig_path</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../../index.html">icolos</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../icolos.html">icolos package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>